services:
  # Auth Service Database
  auth-db:
    image: postgres:16-alpine
    container_name: auth-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: auth_service
    ports:
      - "5435:5432"
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  # Auth Service
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    ports:
      - "8000:8000"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: auth_service
      POSTGRES_HOST: auth-db
      POSTGRES_PORT: 5432
      TOKEN_SECRET: dev-secret-key-change-in-production
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
    depends_on:
      auth-db:
        condition: service_healthy
    volumes:
      - ./auth-service:/app
    networks:
      - microservices-network
    restart: unless-stopped

  # Product Service Database
  # product-db:
  #   image: postgres:16-alpine
  #   container_name: product-db
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: admin
  #     POSTGRES_DB: product_service
  #   ports:
  #     - "5433:5432"
  #   volumes:
  #     - product-db-data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - microservices-network

  # # Product Service
  # product-service:
  #   build:
  #     context: ./product-service
  #     dockerfile: Dockerfile
  #   container_name: product-service
  #   ports:
  #     - "8001:8001"
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: admin
  #     POSTGRES_DB: product_service
  #     POSTGRES_HOST: product-db
  #     POSTGRES_PORT: 5432
  #     TOKEN_SECRET: dev-secret-key-change-in-production
  #     INVENTORY_SERVICE_URL: http://inventory-service:8002
  #     PRODUCT_SERVICE_URL: http://product-service:8001
  #     ALGORITHM: HS256
  #     ACCESS_TOKEN_EXPIRE_MINUTES: 30
  #     REDIS_URL: redis://redis:6379
  #   depends_on:
  #     product-db:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   volumes:
  #     - ./product-service:/app
  #   networks:
  #     - microservices-network
  #   restart: unless-stopped

  # # Inventory Service Database
  # inventory-db:
  #   image: postgres:16-alpine
  #   container_name: inventory-db
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: admin
  #     POSTGRES_DB: inventory_service
  #   ports:
  #     - "5434:5432"
  #   volumes:
  #     - inventory-db-data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - microservices-network

  # # Inventory Service
  # inventory-service:
  #   build:
  #     context: ./inventory-service
  #     dockerfile: Dockerfile
  #   container_name: inventory-service
  #   ports:
  #     - "8002:8002"
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: admin
  #     POSTGRES_DB: inventory_service
  #     POSTGRES_HOST: inventory-db
  #     POSTGRES_PORT: 5432
  #     PRODUCT_SERVICE_URL: http://product-service:8001
  #     AUTH_SERVICE_URL: http://auth-service:8000
  #     TOKEN_SECRET: dev-secret-key-change-in-production
  #   depends_on:
  #     inventory-db:
  #       condition: service_healthy
  #   volumes:
  #     - ./inventory-service:/app
  #   networks:
  #     - microservices-network
  #   restart: unless-stopped

  # Elasticsearch Service
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl --silent --fail localhost:9200/_cluster/health?wait_for_status=yellow&timeout=50s || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - microservices-network
    restart: unless-stopped

  # Booking Service Database
  booking-db:
    image: postgres:16-alpine
    container_name: booking-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: booking_service
    ports:
      - "5436:5432"
    volumes:
      - booking-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  # Booking Service
  booking-service:
    build:
      context: ./booking-service
      dockerfile: Dockerfile
    container_name: booking-service
    ports:
      - "8003:8003"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: booking_service
      POSTGRES_HOST: booking-db
      POSTGRES_PORT: 5432
      PRODUCT_SERVICE_URL: http://product-service:8001
      AUTH_SERVICE_URL: http://auth-service:8000
      TOKEN_SECRET: dev-secret-key-change-in-production
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_PORT: 9200
      ELASTICSEARCH_URL: http://elasticsearch:9200
    depends_on:
      booking-db:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    volumes:
      - ./booking-service:/app
    networks:
      - microservices-network
    restart: unless-stopped

  # Food Service
  # food-service:
  #   build:
  #     context: ./food-service
  #     dockerfile: Dockerfile
  #   container_name: food-service
  #   ports:
  #     - "8004:8004"
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: admin
  #     POSTGRES_DB: food_service
  #     POSTGRES_HOST: food-db
  #     POSTGRES_PORT: 5432
  #     AUTH_SERVICE_URL: http://auth-service:8000
  #     TOKEN_SECRET: dev-secret-key-change-in-production
  #     REDIS_URL: redis://redis:6379
  #   depends_on:
  #     food-db:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   volumes:
  #     - ./food-service:/app
  #   networks:
  #     - microservices-network
  #   restart: unless-stopped

  # # Food Service Database
  # food-db:
  #   image: postgres:16-alpine
  #   container_name: food-db
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: admin
  #     POSTGRES_DB: food_service
  #   ports:
  #     - "5437:5432"
  #   volumes:
  #     - food-db-data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - microservices-network
  # Client (React Frontend)
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: client
    ports:
      - "5173:5173"
    environment:
      - VITE_AUTH_SERVICE_URL=http://localhost:8000
      - VITE_BOOKING_SERVICE_URL=http://localhost:8003
    volumes:
      - ./client:/app
      - /app/node_modules
    networks:
      - microservices-network
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network
    restart: unless-stopped

networks:
  microservices-network:
    driver: bridge

volumes:
  auth-db-data:
  # product-db-data:
  # inventory-db-data:
  booking-db-data:
  redis-data:
  # food-db-data:
  elasticsearch-data:
