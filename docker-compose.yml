services:
  # Auth Service Database
  auth-db:
    image: postgres:16-alpine
    container_name: auth-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: auth_service
    ports:
      - "5435:5432"
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  # Auth Service
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    ports:
      - "8000:8000"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: auth_service
      POSTGRES_HOST: auth-db
      POSTGRES_PORT: 5432
      TOKEN_SECRET: dev-secret-key-change-in-production
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
    depends_on:
      auth-db:
        condition: service_healthy
    volumes:
      - ./auth-service:/app
    networks:
      - microservices-network
    restart: unless-stopped

  # Elasticsearch Service
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl --silent --fail localhost:9200/_cluster/health?wait_for_status=yellow&timeout=50s || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - microservices-network
    restart: unless-stopped

  # Booking Service Database
  booking-db:
    image: postgres:16-alpine
    container_name: booking-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: booking_service
    ports:
      - "5436:5432"
    volumes:
      - booking-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  # Booking Service
  booking-service:
    build:
      context: ./booking-service
      dockerfile: Dockerfile
    container_name: booking-service
    ports:
      - "8003:8003"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: booking_service
      POSTGRES_HOST: booking-db
      POSTGRES_PORT: 5432
      AUTH_SERVICE_URL: http://auth-service:8000
      REDIS_URL: redis://redis:6379
      TOKEN_SECRET: dev-secret-key-change-in-production
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_PORT: 9200
      ELASTICSEARCH_URL: http://elasticsearch:9200
    depends_on:
      redis:
        condition: service_healthy
      booking-db:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    volumes:
      - ./booking-service:/app
    # Increase shared memory for Playwright/Chromium (default 64MB is too small)
    shm_size: "2gb"
    networks:
      - microservices-network
    restart: unless-stopped

  # Food Service Database
  # food-db:
  #   image: postgres:16-alpine
  #   container_name: food-db
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: admin
  #     POSTGRES_DB: food_service
  #   ports:
  #     - "5437:5432"
  #   volumes:
  #     - food-db-data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - microservices-network

  # Food Service
  # food-service:
  #   build:
  #     context: ./food-service
  #     dockerfile: Dockerfile
  #   container_name: food-service
  #   ports:
  #     - "8004:8004"
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: admin
  #     POSTGRES_DB: food_service
  #     POSTGRES_HOST: food-db
  #     POSTGRES_PORT: 5432
  #     AUTH_SERVICE_URL: http://auth-service:8000
  #     TOKEN_SECRET: dev-secret-key-change-in-production
  #     REDIS_URL: redis://redis:6379
  #     RATE_LIMIT_ENABLED: "true"
  #     RATE_LIMIT_MAX_REQUESTS: "100"
  #     RATE_LIMIT_WINDOW_SECONDS: "60"
  #     ENABLE_SHARDING: "false"
  #   depends_on:
  #     food-db:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   volumes:
  #     - ./food-service:/app
  #   networks:
  #     - microservices-network
  #   restart: unless-stopped
  # Client (React Frontend)
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: client
    ports:
      - "5173:5173"
    environment:
      - VITE_AUTH_SERVICE_URL=http://localhost:8000
      - VITE_BOOKING_SERVICE_URL=http://localhost:8003
    volumes:
      - ./client:/app
      - /app/node_modules
    networks:
      - microservices-network
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network
    restart: unless-stopped

  # Nginx Reverse Proxy
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - auth-service
      - booking-service
      # Uncomment when services are enabled:
      # - food-service
      - client
    networks:
      - microservices-network
    restart: unless-stopped

networks:
  microservices-network:
    driver: bridge

volumes:
  auth-db-data:
  booking-db-data:
  redis-data:
  # food-db-data:
  elasticsearch-data:
